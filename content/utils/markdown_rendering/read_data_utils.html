

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Functions for reading data &#8212; ICESat-2 Sea Ice State Analysis</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=927b94d3fcb96560df09" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=927b94d3fcb96560df09" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=927b94d3fcb96560df09" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=927b94d3fcb96560df09" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=927b94d3fcb96560df09" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=927b94d3fcb96560df09" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=927b94d3fcb96560df09"></script>

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-J1HEQ5DMT0"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-J1HEQ5DMT0');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/utils/markdown_rendering/read_data_utils';</script>
    <link rel="shortcut icon" href="../../../_static/logo.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Functions for plotting and mapping" href="plotting_utils.html" />
    <link rel="prev" title="ICESat-2 interpolation workflow" href="../../9_gridded_interp_demo.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../0_home.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../0_home.html">
                    ICESat-2 Arctic Sea Ice State Analysis
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ICESat-2 Arctic sea ice thickness data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../1_is2sitmogr4_intro.html">ICESat-2 L4 Monthly Gridded Sea Ice Thickness Dataset (IS2SITMOGR4)</a></li>





</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Winter Arctic sea ice thickness analysis (Petty et al., 2023)</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../2_winter_arctic_sea_ice_variability.html">Winter Arctic sea ice state variability</a></li>







<li class="toctree-l1"><a class="reference internal" href="../../3_comparisons_with_cryosat-2_and_piomas.html">Comparisons with CryoSat-2 and PIOMAS sea ice thickness estimates</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../4_comparisons_with_BGEP.html">Comparisons with BGEP ULS sea ice draft estimates</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../5_atmospheric_variability.html">Atmospheric variability</a></li>




</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Winter Arctic sea ice thickness analysis updates</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../2b_winter_arctic_sea_ice_variability_2022update.html">Winter Arctic sea ice state variability (updates through to April 2022)</a></li>





</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data wrangling</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../7_gridded_data_wrangling.html">Data wrangling</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../8_cryosat-2_data_wrangling.html">CryoSat-2 data wrangling</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../9_gridded_interp_demo.html">ICESat-2 interpolation workflow</a></li>





</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Ancillary code</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Functions for reading data</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting_utils.html">Functions for plotting and mapping</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/akpetty/icesat2-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/akpetty/icesat2-book/edit/master/content/utils/markdown_rendering/read_data_utils.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/akpetty/icesat2-book/issues/new?title=Issue%20on%20page%20%2Fcontent/utils/markdown_rendering/read_data_utils.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/content/utils/markdown_rendering/read_data_utils.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Functions for reading data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="functions-for-reading-data">
<h1>Functions for reading data<a class="headerlink" href="#functions-for-reading-data" title="Permalink to this heading">#</a></h1>
<p>This is a markdown rendering of the <code class="docutils literal notranslate"><span class="pre">read_data_utils</span></code> module used in the notebooks. It is provided here for user reference, and may not reflect any changes to the code after 12/15/2021. The code can be viewed and downloaded from the github repository.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; read_data_utils.py </span>

<span class="sd">Helper functions for reading ICESat2 data from a local drive and the book netcdf file from the google storage bucket</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> 
<span class="kn">import</span> <span class="nn">s3fs</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_ISSITGR4</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">&#39;001&#39;</span><span class="p">,</span> <span class="n">local_data_path</span><span class="o">=</span><span class="s2">&quot;/data/ISSITGR4/&quot;</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Read in ISSITGR4 campaign gridded thickness dataset from local netcdf files</span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        version (str, required): ISSITGR4 version (default &quot;001&quot;)</span>
<span class="sd">        local_data_path (str, required): local data directory</span>

<span class="sd">    Returns: </span>
<span class="sd">        is_ds (xr.Dataset): aggregated ISSITGR4 xarray dataset.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">current_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span>
    
    <span class="c1"># Read in files for each month as a single xr.Dataset</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">current_path</span><span class="o">+</span><span class="n">local_data_path</span><span class="o">+</span><span class="n">version</span><span class="o">+</span><span class="s1">&#39;/*.nc&#39;</span><span class="p">)</span>
    <span class="c1">#print(&#39;Number of netcdf files available locally:&#39;, len(filenames), filenames, current_path+local_data_path+version+&#39;/&#39;)</span>

    <span class="c1"># Raise error if no files found</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Still not files, exit&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Load in netcdf files to xarray dataset&#39;</span><span class="p">)</span>
    <span class="n">datasets_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">ds_campaign</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">ds_campaign</span> <span class="o">=</span> <span class="n">ds_campaign</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">])</span> <span class="c1"># Set data variables as coordinates</span>
        <span class="n">mean_campaign_time_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds_campaign</span><span class="o">.</span><span class="n">campaign_dates</span><span class="o">.</span><span class="n">first_day</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mean_campaign_time_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds_campaign</span><span class="o">.</span><span class="n">campaign_dates</span><span class="o">.</span><span class="n">last_day</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">mean_campaign_time</span> <span class="o">=</span> <span class="n">mean_campaign_time_1</span><span class="o">+</span><span class="p">(</span><span class="n">mean_campaign_time_2</span><span class="o">-</span><span class="n">mean_campaign_time_1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        
        <span class="n">ds_campaign</span> <span class="o">=</span> <span class="n">ds_campaign</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="n">mean_campaign_time</span><span class="p">})</span> <span class="c1"># Add time as coordinate</span>
        <span class="n">ds_campaign</span> <span class="o">=</span> <span class="n">ds_campaign</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="c1"># Set month as a dimension </span>
        <span class="n">datasets_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_campaign</span><span class="p">)</span>

    <span class="n">is_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">datasets_list</span><span class="p">)</span>
    <span class="n">is_ds</span> <span class="o">=</span> <span class="n">is_ds</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">is_ds</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_time_dim_v2</span><span class="p">(</span><span class="n">xda</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; dummy function to just set current time as a new dimension to concat files over, change later! &quot;&quot;&quot;</span>
    <span class="n">xda</span> <span class="o">=</span> <span class="n">xda</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;xgrid&quot;</span><span class="p">,</span> <span class="s2">&quot;ygrid&quot;</span><span class="p">])</span>
    <span class="n">xda</span> <span class="o">=</span> <span class="n">xda</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">xda</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_time_dim_v3</span><span class="p">(</span><span class="n">xda</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; dummy function to just set current time as a new dimension to concat files over, change later! &quot;&quot;&quot;</span>
    <span class="n">xda</span> <span class="o">=</span> <span class="n">xda</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
    <span class="n">xda</span> <span class="o">=</span> <span class="n">xda</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">xda</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_IS2SITMOGR4</span><span class="p">(</span><span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;zarr-s3&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;V3&#39;</span><span class="p">,</span> <span class="n">local_data_path</span><span class="o">=</span><span class="s2">&quot;/data/IS2SITMOGR4/&quot;</span><span class="p">,</span> 
    <span class="n">bucket_name</span><span class="o">=</span><span class="s2">&quot;icesat-2-sea-ice-us-west-2&quot;</span><span class="p">,</span> <span class="n">persist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Read in IS2SITMOGR4 monthly gridded thickness dataset from local netcdf files, download the netcdf files from S3 storage, or read in the aggregated zarr dataset from S3. Currently supports either Version 2 (V2) or Version 3 (V3) data. </span>
<span class="sd">    </span>
<span class="sd">    Note than in Version 3 there was a change in the xgrid/ygrid coordinates to x/y.</span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        data_type (str, required): (default to &quot;zarr-s3&quot;, but also &quot;netcdf-s3&quot; or &quot;netcdf-local&quot; which is a local version of the netcdf files)</span>
<span class="sd">        version (str, required): IS2SITMOGR4 version (default &quot;V2&quot;)</span>
<span class="sd">        local_data_path (str, required): local data directory</span>
<span class="sd">        bucket_name (str, required): S3 bucket name</span>
<span class="sd">        persist (boleen, required): if zarr option decide if you want to persist (load) data into memory</span>
<span class="sd">        download (boleen, required): download from s3 bucket to local storage</span>

<span class="sd">    Returns: </span>
<span class="sd">        is2_ds (xr.Dataset): aggregated IS2SITMOGR4 xarray dataset, dask chunked/virtually allocated in the case of the zarr option (or allocated to memory if persisted). </span>
<span class="sd">        </span>
<span class="sd">    Version History: </span>
<span class="sd">        (November 2023 for V3 data release):  </span>
<span class="sd">            - Moved the download code to it&#39;s own section at the start of the function</span>
<span class="sd">            - Changed local paths</span>
<span class="sd">            - Baked in the date_str label as that is just a function of the dataset version anyway</span>
<span class="sd">            - Adapted the netcdf reader to use open_mfdataset, required a preprocessing data dimension step. Much more elegant!</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">download</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;download from S3 bucket: &quot;</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>

        <span class="c1"># Download netCDF data files</span>
        <span class="n">s3_path</span> <span class="o">=</span> <span class="s1">&#39;s3://&#39;</span><span class="o">+</span><span class="n">bucket_name</span><span class="o">+</span><span class="s1">&#39;/IS2SITMOGR4_&#39;</span><span class="o">+</span><span class="n">version</span><span class="o">+</span><span class="s1">&#39;/netcdf/&#39;</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#files references the entire bucket.</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">s3_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading file from bucket to local storage...&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">local_data_path</span><span class="o">+</span><span class="n">version</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">data_type</span><span class="o">==</span><span class="s1">&#39;zarr-s3&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">version</span><span class="o">==</span><span class="s1">&#39;V2&#39;</span><span class="p">:</span>
            <span class="n">date_str</span><span class="o">=</span><span class="s1">&#39;201811-202204&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date_str</span><span class="o">=</span><span class="s1">&#39;201811-202304&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;load zarr from S3 bucket: &#39;</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
        <span class="n">s3_path</span> <span class="o">=</span> <span class="s1">&#39;s3://&#39;</span><span class="o">+</span><span class="n">bucket_name</span><span class="o">+</span><span class="s1">&#39;/IS2SITMOGR4_&#39;</span><span class="o">+</span><span class="n">version</span><span class="o">+</span><span class="s1">&#39;/zarr/IS2SITMOGR4_&#39;</span><span class="o">+</span><span class="n">version</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">date_str</span><span class="o">+</span><span class="s1">&#39;.zarr/all/&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;zarr_path:&#39;</span><span class="p">,</span> <span class="n">s3_path</span><span class="p">)</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3Map</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">s3_path</span><span class="p">,</span> <span class="n">s3</span><span class="o">=</span><span class="n">s3</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>
        
        <span class="c1"># Had a problem with these being loaded as dask arrays which cartopy doesnt like</span>
        <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">persist</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">data_type</span><span class="o">==</span><span class="s1">&#39;netcdf&#39;</span><span class="p">:</span>
        
        <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">local_data_path</span><span class="o">+</span><span class="n">version</span><span class="o">+</span><span class="s1">&#39;/*.nc&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No files, exit&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;IS2SITMOGR4_01_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;%Y%m&quot;</span><span class="p">)</span>  <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">]</span>
        <span class="c1"># Add a dummy time then add the dates I want, seemed the easiest solution</span>
        <span class="k">if</span> <span class="n">version</span><span class="o">==</span><span class="s1">&#39;V2&#39;</span><span class="p">:</span>
            <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">preprocess</span> <span class="o">=</span> <span class="n">add_time_dim_v2</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;netcdf4&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">preprocess</span> <span class="o">=</span> <span class="n">add_time_dim_v3</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;netcdf4&#39;</span><span class="p">)</span>
                
        <span class="n">is2_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dates</span>

        <span class="c1"># Sort by time as glob file list wasn&#39;t!</span>
        <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">version</span><span class="o">==</span><span class="s1">&#39;V2&#39;</span><span class="p">:</span>
            <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span><span class="s2">&quot;xgrid&quot;</span><span class="p">,</span><span class="s2">&quot;ygrid&quot;</span><span class="p">])</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
        
        <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="p">([</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        
        <span class="n">is2_ds</span> <span class="o">=</span> <span class="n">is2_ds</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Aggregated IS2SITMOGR4 &quot;</span><span class="o">+</span><span class="n">version</span><span class="o">+</span><span class="s2">&quot; dataset.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">is2_ds</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_book_data</span><span class="p">(</span><span class="n">local_path</span><span class="o">=</span><span class="s1">&#39;/data/&#39;</span><span class="p">,</span> <span class="n">CS2</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Read in data for ICESat2 jupyter book. </span>
<span class="sd">    If the file does not already exist on the user&#39;s local drive, it is downloaded from our S3 bucket</span>
<span class="sd">    The netcdf file is then read in as an xr.Dataset object </span>

<span class="sd">    To do:</span>
<span class="sd">     - Add zarr functionality to this to avoid having to download the netcdf.</span>
<span class="sd">    </span>
<span class="sd">    Args: </span>
<span class="sd">        local_path (str, required): local data directory</span>
<span class="sd">        CS2 (boleen, required): choose if we want to also read in the wrangled CS-2 thickness data</span>
<span class="sd">    Returns: </span>
<span class="sd">        book_ds (xr.Dataset): data </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">CS2</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;IS2_CS2_jbook_dataset_201811-202104.nc&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;IS2_jbook_dataset_201811-202104.nc&quot;</span>
    
    <span class="c1"># Check if file exists on local drive</span>
    <span class="n">current_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">exists_locally</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">current_path</span><span class="o">+</span><span class="n">local_path</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span> 
    
    <span class="k">if</span> <span class="p">(</span><span class="n">exists_locally</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span> 
        <span class="c1"># Download data </span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading jupyter book data from the S3 bucket...&quot;</span><span class="p">)</span>
        <span class="n">s3_path</span> <span class="o">=</span> <span class="s1">&#39;s3://icesat-2-sea-ice-us-west-2/book_data/&#39;</span><span class="o">+</span><span class="n">filename</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">current_path</span><span class="o">+</span><span class="n">local_data_path</span><span class="p">)</span>

    <span class="n">book_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">current_path</span><span class="o">+</span><span class="n">local_path</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">book_ds</span>

</pre></div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/utils/markdown_rendering"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../../9_gridded_interp_demo.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">ICESat-2 interpolation workflow</p>
      </div>
    </a>
    <a class="right-next"
       href="plotting_utils.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Functions for plotting and mapping</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Nicole Keeney and Alek Petty
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      Â© Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  Distributed under the MIT license
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=927b94d3fcb96560df09"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=927b94d3fcb96560df09"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>